# 仕様書・コード対応クロスリファレンス
# Specification-Code Cross Reference

**プロジェクト:** eminj-acw-16
**作成日:** 2025-11-07
**対象:** Sub2タスク - l_mat.cと仕様書の対応関係マッピング

================================================================================

## エグゼクティブサマリー

### ドキュメント構成

| 項目 | 仕様書 | ソースコード |
|------|--------|--------------|
| ファイル名 | 11eminj-acw-15-c-t.docx | eminj_l_mat.c |
| 場所 | base/eminj-acw-15-c-t_spec/ | base/eminj-acw-15-c-t_src/ |
| サイズ | 段落数: 1122, テーブル数: 20 | 行数: 4962 |

### 機能概要

**部品名:** minj (Mediation INJection)

**主要機能:**
- 各機能が要求する噴射モードを集約
- 最適な混合気形成のための優先調停
- 調停後の要求値をSACに公開
- 8msタスク処理での要求受付

================================================================================

## 1. 変数マッピング (仕様書 Table 1 ⇔ コード)

### 1.1 公開変数

| 変数名 | 機能名 | 型 | コード内行番号 | 備考 |
|--------|--------|-----|---------------|------|
| einjmod | 噴射ﾓｰﾄﾞ | u2 | 463, 562 | - |
| einjmodfix | 現在確定噴射ﾓｰﾄﾞ | u2 | 463, 1613 | - |
| einjptn | 噴射ﾊﾟﾀｰﾝ | u4 | 632, 911 | - |
| eainjp1 | ﾎﾟｰﾄ1回目噴射開始時期 | s2 | 563, 564 | - |
| eainjp1 | ﾎﾟｰﾄ1回目噴射開始時期 | f4 | 563, 564 | - |
| eainjp2 | ﾎﾟｰﾄ2回目噴射開始時期 | s2 | 565, 566 | - |
| eainjp2 | ﾎﾟｰﾄ2回目噴射開始時期 | f4 | 565, 566 | - |
| eainjp3 | ﾎﾟｰﾄ3回目噴射開始時期 | s2 | 567, 568 | - |
| eainjp3 | ﾎﾟｰﾄ3回目噴射開始時期 | f4 | 567, 568 | - |
| eainjp4 | ﾎﾟｰﾄ4回目噴射開始時期 | s2 | 569, 570 | - |
| eainjp4 | ﾎﾟｰﾄ4回目噴射開始時期 | f4 | 569, 570 | - |
| eainjpn[5] | ﾎﾟｰﾄn回目噴射開始時期(噴射回数配列) | s2 | 466, 467 | - |
| eainjpn[5] | ﾎﾟｰﾄn回目噴射開始時期(噴射回数配列) | f4 | 466, 467 | - |
| einjend | ﾎﾟｰﾄ噴射終了時期 | s2 | 465, 559 | - |
| einjend | ﾎﾟｰﾄ噴射終了時期 | f4 | 465, 559 | - |
| eainjcutp | ﾎﾟｰﾄ噴射強制ｶｯﾄ時期 | s2 | 128, 571 | - |
| eainjcutp | ﾎﾟｰﾄ噴射強制ｶｯﾄ時期 | f4 | 128, 571 | - |
| eainjd1 | 筒内1回目噴射開始時期 | s2 | 472, 573 | - |
| eainjd1 | 筒内1回目噴射開始時期 | f4 | 472, 573 | - |
| eainjd2 | 筒内2回目噴射開始時期 | s2 | 473, 575 | - |
| eainjd2 | 筒内2回目噴射開始時期 | f4 | 473, 575 | - |
| eainjd3 | 筒内3回目噴射開始時期 | s2 | 474, 577 | - |
| eainjd3 | 筒内3回目噴射開始時期 | f4 | 474, 577 | - |
| eainjd4 | 筒内4回目噴射開始時期 | s2 | 475, 579 | - |
| eainjd4 | 筒内4回目噴射開始時期 | f4 | 475, 579 | - |
| eainjd1fix | 確定筒内1回目噴射開始時期 | f4 | 472, 1922 | - |
| eainjd2fix | 確定筒内2回目噴射開始時期 | f4 | 473, 1922 | - |
| eainjd3fix | 確定筒内3回目噴射開始時期 | f4 | 474, 1923 | - |
| eainjd4fix | 確定筒内4回目噴射開始時期 | f4 | 475, 1923 | - |


## 2. 関数マッピング

### 2.1 公開関数 (Public Interface)

| 関数名 | 行番号 | 仕様書記載 | 処理内容 |
|--------|--------|-----------|----------|
| vdg_eminj_pwon | 722-804 | 初期化処理 | パワーオン時の初期化 |
| vdg_eminj_8msm | 815-2602 | 8ms中タスク | 噴射要求の調停処理 |
| vdg_eminj_einj_dataget | 2605-2728 | データ取得 | 噴射データ公開 |
| vdg_eminj_eminj_dataget | 2731-2853 | データ取得 | 調停データ公開 |

### 2.2 内部関数 (Static Functions)

| 関数名 | 行番号 | 呼び出し元 | 処理内容 |
|--------|--------|-----------|----------|
| vds_eminj_eminj_hpri | 2855 | vdg_eminj_8msm | 噴射要求優先度判定 |
| vds_eminj_eminjlmt_hpri | 3737 | vdg_eminj_8msm | 噴射制限優先度判定 |
| vds_eminj_einj_dataset | 4014 | vdg_eminj_pwon等 | 噴射データセット設定 |
| vds_eminj_einj_datacopy | 4163 | vdg_eminj_8msm | 噴射データコピー |
| vds_eminj_eminj_dataset | 4245 | vdg_eminj_pwon等 | 調停データセット設定 |
| vds_eminj_einj_datacopy2 | 4380 | vdg_eminj_8msm | データバッファコピー |
| vds_eminj_einj_dataconv | 4469 | vdg_eminj_8msm | データ形式変換 |
| vds_eminj_einj_dataconv_rev | 4668 | vdg_eminj_8msm | データ逆変換 |


## 3. データ構造マッピング

### 3.1 主要構造体

| 構造体名 | 定義行 | 用途 | メンバー例 |
|----------|--------|------|-----------|
| st_EMINJ_EMINJ_DEF | 345 | 調停要求データ定義 | pt_dataget, 要求ID |
| st_EMINJ_EMINJ_BUF | 351 | 調停バッファ | pt_dataget2 |
| st_EMINJ_EMINJ | 457 | 調停結果データ | 公開用データ |
| st_EMINJ_EINJ | 460 | 噴射データ | 噴射パラメータ |

### 3.2 グローバル変数

| 変数名 | 行番号 | 用途 |
|--------|--------|------|
| stg_eminj_eminj | 457 | - |
| stg_eminj_einj | 460 | - |
| f4g_eminj_einjend | 465 | - |
| s2g_eminj_eainjpn | 466 | - |
| f4g_eminj_eainjpn | 467 | - |
| f4g_eminj_eqinjstpn | 469 | - |
| f4g_eminj_eainjd1fix | 472 | - |
| f4g_eminj_eainjd2fix | 473 | - |
| f4g_eminj_eainjd3fix | 474 | - |
| f4g_eminj_eainjd4fix | 475 | - |
| f4g_eminj_eainjd5fix | 476 | - |
| f4g_eminj_eainjd6fix | 477 | - |
| s2g_eminj_eainjdn | 478 | - |
| f4g_eminj_eainjdn | 479 | - |
| f4g_eminj_eqinjstd1 | 480 | - |


## 4. コンパイルスイッチ詳細

### 4.1 主要スイッチと制御範囲

#### JEEFI
- **説明:** EFI種別: デュアルINJ/D-4/ポート噴射
- **使用回数:** 486
- **設定値:** u1g_EJCC_DUAL, u1g_EJCC_D4, u1g_EJCC_PORT
- **制御ブロック:** 行 34, 46, 49

#### JESS
- **説明:** アイドルストップ機能の有無
- **使用回数:** 17
- **設定値:** u1g_EJCC_USE, u1g_EJCC_NOT_USE
- **制御ブロック:** 行 41, 187

#### JEALLHV_E
- **説明:** ハイブリッド車仕様
- **使用回数:** 79
- **設定値:** u1g_EJCC_ALLHV_E
- **制御ブロック:** 行 31, 54, 57

#### JEEGMG_E
- **説明:** EG-MG制御種別
- **使用回数:** 47
- **設定値:** u1g_EJCC_HVPLGR_E, u1g_EJCC_HVDIRECT_E, u1g_EJCC_HVCLUTCH_E
- **制御ブロック:** 行 38, 41, 60


## 5. 処理フロー

### 5.1 vdg_eminj_8msm() 処理フロー

```
1. 初期化・前処理
   - NE タスク実行フラグ取得
   - 噴射モード無効ID設定

2. 各機能からのデータ取得 (emedi_dataget系)
   - 40+ 個の機能モジュールから要求取得
   - コンパイルスイッチで有効/無効制御

3. 優先調停処理
   - vds_eminj_eminj_hpri() : 噴射要求優先度判定
   - vds_eminj_eminjlmt_hpri() : 制限要求優先度判定

4. データ変換・コピー
   - vds_eminj_einj_datacopy() : 噴射データコピー
   - vds_eminj_einj_dataconv() : データ形式変換

5. SAC要求受付
   - vdg_ainjif_renew_injrq() : SAC IF更新
```

## 6. 仕様書テーブル対応

| Table# | テーブル名 | 内容 | コード対応 |
|--------|-----------|------|-----------|
| 0 | 要求定義 | システム要求の定義 | コード全体に対応 |
| 1 | 公開変数リスト | 109個の変数定義 | グローバル変数宣言 |
| 2 | 公開先(einj) | 39個の変数公開 | vdg_eminj_einj_dataget |
| 3 | 公開先(eminj) | 27個の変数公開 | vdg_eminj_eminj_dataget |
| 4 | 内部変数 | 10個の内部変数 | ローカル/static変数 |
| 6 | 要求優先度テーブル | 11個の要求定義 | vds_eminj_eminj_hpri |
| 8 | 制限要求テーブル | 7個の制限定義 | vds_eminj_eminjlmt_hpri |


## 7. まとめ

### 7.1 対応関係サマリー

| 項目 | 仕様書 | コード | 対応状況 |
|------|--------|--------|----------|
| 公開関数 | 4個記載 | 4個実装 | ✓ 完全一致 |
| 内部関数 | 暗黙的 | 12個実装 | ✓ 実装済 |
| 公開変数 | 109個定義 | 実装確認済 | ✓ テーブル参照 |
| データ構造 | 4種類 | 4種類実装 | ✓ 完全一致 |
| コンパイルスイッチ | 10+個 | 対応実装 | ✓ 条件分岐 |

### 7.2 重要な実装ポイント

1. **多様なコンパイルスイッチ対応**
   - JEEFI, JESS, JEALLHV_E等により動作を切替
   - 車種・仕様により異なるビルド構成

2. **40+の機能モジュール連携**
   - emedi_dataget/emedi_dataget2インターフェース
   - 統一された要求データ取得方式

3. **優先調停メカニズム**
   - 要求優先度テーブルに基づく調停
   - 制限要求の優先判定

4. **SAC連携**
   - 8msタスク最後にSAC要求更新
   - アプリ要求との同時性確保

================================================================================

## 付録: 参照情報

### 関連ファイル
- eminj.h : データ構造定義ヘッダー
- eminj_c_mat.c : 関連実装ファイル
- 各種emedi_dataget実装モジュール

### ドキュメント
- 11eminj-acw-15-c-t.docx : メイン仕様書
- 11eminj-acw-15-c-t.xlsx : 補足資料
- ロジック変更シート_ver9.09_eminj.xlsx : 変更履歴
