# 仕様書差分分析レポート

## プロジェクト概要
- **ベース**: eminj-acw-15-c-t (eminj-pcw00-1500-a-t-M4)
- **新規**: eminj-acw-16-a-t
- **分析日**: 2025-11-07
- **文字コード**: CP932（日本語コメント対応）

## 1. ファイル構成

### 1.1 ベース側（eminj-acw-15）
```
base/
├── eminj-acw-15-c-t_spec/
│   ├── 11eminj-acw-15-c-t.docx
│   ├── 11eminj-acw-15-c-t.xlsx
│   ├── 11eminj-acw-15-c-t_フリーポート設定書.xlsx
│   └── document/
│       └── ロジック変更シート_ver9.09_eminj.xlsx
└── eminj-acw-15-c-t_src/
    ├── eminj.h (1,323行)
    ├── eminj_c.h (362行)
    ├── eminj_c_mat.c (659行)
    ├── eminj_l_mat.c (4,961行)
    └── 部品情報_eminj-pcw00-1500.xlsx
```

### 1.2 新規側（eminj-acw-16）
```
new/
└── eminj-acw-16-a-t/
    ├── 11eminj-acw-16-a-t.docx
    ├── 11eminj-acw-16-a-t.xlsx
    ├── 11eminj-acw-16-a-t_フリーポート設定書.xlsx
    ├── eminj-kjcw00-1600-a-t-zkj.xlsx
    └── document/
        ├── ロジック変更シート_ver9.09_eminj.xlsx
        ├── 参照元チェックシート_ver2.11_eminj-acw-16-a-t.xlsx
        ├── 参照先チェックシート_eminj-acw-16-a-t.xlsx
        └── 定数管理エクセル_eminj-acw-16-a-t.xlsm
```

## 2. 主要な差分ポイント

### 2.1 ソースコードファイルの有無
- **ベース側**: ソースコード（.c, .h）が存在
- **新規側**: ソースコードが**存在しない**（仕様書のみ）
  - → **新規コード生成が必要**

### 2.2 新規ドキュメント（eminj-acw-16のみ）
1. **参照元チェックシート_ver2.11_eminj-acw-16-a-t.xlsx**
   - 参照元の依存関係管理
   
2. **参照先チェックシート_eminj-acw-16-a-t.xlsx**
   - 参照先の依存関係管理
   
3. **定数管理エクセル_eminj-acw-16-a-t.xlsm**
   - 定数の一元管理（マクロ付き）
   - c_mat.cの定数生成に使用される可能性

4. **eminj-kjcw00-1600-a-t-zkj.xlsx**
   - 部品情報（1600系）

## 3. ヘッダーファイル（eminj.h）の主要機能

### 3.1 コンパイルスイッチ定義
eminj.hには以下のコンパイルスイッチが定義されています：

#### 基本システム構成
- `JEEFI`: 燃料噴射システムタイプ
  - `u1g_EJCC_D4`: D-4システム
  - `u1g_EJCC_DUAL`: 筒内INJ（直噴）
  - `u1g_EJCC_PORT`: ポート噴射
  
- `JESS`: Start-Stop機能
- `JEMAT_BENCHI`: ベンチ機能（開発用）
- `JEPRDEMAND`: 可変燃料圧力

#### HV関連
- `JEALLHV_E`: ALL HV（ハイブリッド）機能
- `JEEGMG_E`: EG-MG機能
  - `u1g_EJCC_HVPLGR_E`: EG-MGプラグイン
  - `u1g_EJCC_HVDIRECT_E`: EG-MGダイレクト
  - `u1g_EJCC_HVCLUTCH_E`: EG-MGクラッチ

#### 排ガス関連
- `JEEGR`: EGR（排気再循環）
- `JENGPF_E`: GPF（ガソリン微粒子フィルター）
- `u1g_EJCC_NOX`: NOx関連

#### 製品構成
- `JECOMBCCPT_E`: 燃焼コンセプト
- `u1g_EJCC_SPRAYG_E`: スプレーガイド
- `JEFFV`: FFV（フレキシブル燃料車）

#### OBD関連
- `JEOBDAFIMB_D`: AF学習インバランス診断
- `JEOBDMF`: 失火OBD
- `JEOBDFKG`: 燃料系OBD

### 3.2 媒介優先度ID定義
各機能モジュールの調停優先度が定義されています：

| ID定義 | 優先度 | 機能 | 条件コンパイル |
|--------|--------|------|----------------|
| `u1g_EMINJ_BENCH_ID` | 100 | ベンチ機能用噴射要求 | ベンチ機能有効 |
| `u1g_EMINJ_EGSTPVS_ID` | 102 | 噴射停止 | - |
| `u1g_EMINJ_DEFLAIR_ID` | 103 | 制御異常保護 | 筒内INJ |
| `u1g_EMINJ_STPHV_ID` | 106 | HV停止保護 | EG-MGプラグイン/ダイレクト |
| `u1g_EMINJ_STPSS_ID` | 107 | SS停止保護 | SS機能有効 or EG-MGクラッチ |
| `u1g_EMINJ_RDNVES_ID` | 108 | 振動低減停止・始動保護 | ALL HV |
| `u1g_EMINJ_SJC_ID` | 110 | エマージェンシー保護 | 筒内INJ or D-4 |
| `u1g_EMINJ_BINJPLCTR_WC_ID` | 111 | ポート基本噴射制御（暖機時） | ALL HV and PL多段噴射 |
| `u1g_EMINJ_WUPCAT_ID` | 112 | 触媒暖機保護 | ALL HV |
| `u1g_EMINJ_FCFRCTRL_ID` | 113 | 1気筒FC制御 | GPF有効 |
| `u1g_EMINJ_STACM_ID` | 114 | 始動燃焼制御保護 | 遠隔始動 or 車外始動 |
| `u1g_EMINJ_STASS_ID` | 115 | SS始動保護 | SS機能有効 or EG-MGクラッチ |

### 3.3 データ構造

#### 標準対象用構造体 (`st_EMINJ_EMINJ_DEF`)
- 噴射要求情報（`u4_einjrq_dat`）
- 噴射モード（`u2_einjmod`）
- ポート/筒内噴射開始角度（`s2_eainjp1-4`, `s2_eainjd1-4`）
- 噴射量（`s4_eqinjstp1-4`, `s4_eqinjstd1-4`）
- FC筒内噴射量（`s4_eqfc[]`）
- 噴射量補正係数（`s2_ek1f`, `s2_ek2f`, `s2_ek3f`）
- 燃圧要求（`s2_eprreq`, `s2_eprreql`）
- PL噴射実施要求（`u1_explreq`）

#### 媒介データ構造体 (`st_EMINJ_EINJ`)
- 標準対象用と同様のパラメータに加え、float型変数も保持
- 固定値（`f4_eainjd1fix` - `f4_eainjd6fix`）
- 補正係数固定値（`f4_ek1ffix`, `f4_ek2ffix`, `f4_ek3ffix`）

#### 集団対象用構造体 (`st_EMINJ_EMINJ`)
- 噴射パターン（`u4_einjptn`）
- 配列形式の噴射パラメータ
  - `s2_eainjpn[5]`: ポートn回目噴射開始角度
  - `s2_eainjdn[6]`: 筒内n回目噴射開始角度
  - `s4_eqinjstpn[5]`: ポートn回目始動噴射量
  - `s4_eqinjstdn[6]`: 筒内n回目始動噴射量
  - `s4_eqinjflfix[8]`: FL固定噴射量
  - `s4_eqinjplfix[8]`: PL固定噴射量

## 4. 定数定義ファイル（eminj_c_mat.c）の構造

### 4.1 セクション定義
```c
#pragma ghs section rozdata = ".mat_eminj"
```
- Read-Only Data（読み取り専用データ）セクション
- 定数テーブルの配置用

### 4.2 コンパイルバージョンチェック
```c
#define MK32_ID (0x00000040)  /* R9コンパイラ使用 */
__GHS_VERSION_NUMBER: 201355 - 201400
```

### 4.3 優先度定数（volatile const）
各機能モジュールの調停優先度を定義：

```c
volatile const u1 u1g_eminj_BENCH_PRI = 2;      // ベンチ機能
volatile const u1 u1g_eminj_EGSTPVS_PRI = 4;    // 噴射停止
volatile const u1 u1g_eminj_DEFLAIR_PRI = 6;    // 制御異常保護
volatile const u1 u1g_eminj_STPHV_PRI = 12;     // HV停止保護
volatile const u1 u1g_eminj_STPSS_PRI = 14;     // SS停止保護
// ... 他多数
```

### 4.4 フリーポート用優先度
```c
#if EMINJ_FREE0 == ON
volatile const u1 u1g_eminj_FREE0_PRI = ...;
#endif
// FREE0 - FREE11まで定義可能
```

## 5. ロジック実装ファイル（eminj_l_mat.c）の構造

### 5.1 主要関数
1. **vdg_eminj_pwon()**: 初期値設定（電源ON時）
2. **vdg_eminj_8msm()**: 噴射要求調停処理（8ms周期）
3. **vdg_eminj_einj_dataget()**: 噴射情報取得（構造体1）
4. **vdg_eminj_eminj_dataget()**: 噴射情報取得（構造体2）

### 5.2 処理フロー
1. 各機能モジュールからのデータ取得
2. 優先度に基づく調停
3. 噴射パラメータの決定
4. 出力データ構造体への格納

## 6. 差分生成に必要な作業

### 6.1 サブタスク3: c_mat.c の定数差分対応版生成
**入力**:
- base/eminj_c_mat.c（ベース版）
- new/document/定数管理エクセル_eminj-acw-16-a-t.xlsm

**作業内容**:
1. 定数管理エクセルから新規定数値を抽出
2. ベース版との差分特定
3. 新規定数値で更新したc_mat.c生成
4. コンパイルスイッチ条件の更新

**出力**:
- new/sub3/eminj_c_mat.c（eminj-acw-16対応版）

### 6.2 サブタスク4: l_mat.c のロジック差分対応版生成
**入力**:
- base/eminj_l_mat.c（ベース版）
- new/document/ロジック変更シート_ver9.09_eminj.xlsx
- new/document/参照元チェックシート_ver2.11_eminj-acw-16-a-t.xlsx
- new/document/参照先チェックシート_eminj-acw-16-a-t.xlsx

**作業内容**:
1. ロジック変更シートから変更点を抽出
2. 参照関係チェックシートで依存関係確認
3. ベース版ロジックの差分特定
4. 新規ロジックで更新したl_mat.c生成
5. 関数インターフェースの更新

**出力**:
- new/sub4/eminj_l_mat.c（eminj-acw-16対応版）

## 7. 品質確保事項

### 7.1 文字コード
- CP932（Shift_JIS）を維持
- 日本語コメントの文字化け防止

### 7.2 コンパイラ互換性
- GHS R9コンパイラ（201355-201400）
- `#pragma ghs` ディレクティブの維持

### 7.3 コーディング規約
- Toyota Motor Corporation標準
- 変数命名規則の遵守
- コメント形式の統一

## 8. 次ステップ

### 8.1 サブタスク2の実施
l_mat.cとドキュメントの対応関係マッピング作成

### 8.2 Excel仕様書の詳細分析
新規ドキュメントから以下を抽出：
- 定数値の変更リスト
- ロジック変更内容
- インターフェース変更

### 8.3 差分コード生成
サブタスク3, 4の実施

---

**作成者**: Copilot Workspace  
**作成日**: 2025-11-07  
**版数**: 1.0
