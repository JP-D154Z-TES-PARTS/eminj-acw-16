# l_mat.c ロジック差分対応版 生成レポート

## ドキュメント情報
- **作成日**: 2025-11-07  
- **対象ファイル**: eminj_l_mat.c
- **ベースバージョン**: eminj-pcw00-1500-a-t-M4 (eminj-acw-15)
- **新バージョン**: eminj-acw-16-a-t
- **文字コード**: CP932

## 分析結果サマリー

### ファイル概要
- **行数**: 4,961行
- **主要機能**: 噴射要求調停処理
- **更新タイミング**: 
  - pwon時（電源ON時初期化）
  - 8msm周期（調停処理）

## ベースファイル構造分析

### 主要関数リスト

#### 外部公開関数（Public Functions）
1. **vdg_eminj_pwon()** - 初期値設定
2. **vdg_eminj_8msm()** - 噴射要求調停処理
3. **vdg_eminj_einj_dataget()** - 噴射情報取得（構造体1）
4. **vdg_eminj_eminj_dataget()** - 噴射情報取得（構造体2）

#### 内部関数（Static Functions）
1. **vds_eminj_eminj_hpri()** - 優先度調停（高優先度優先）
2. **vds_eminj_eminjlmt_hpri()** - リミット付き優先度調停
3. **vds_eminj_einj_dataset()** - 媒介データ構造体設定
4. **vds_eminj_einj_datacopy()** - 標準対象用構造体コピー
5. **vds_eminj_eminj_dataset()** - 集団対象用構造体設定
6. **vds_eminj_einj_datacopy2()** - バッファ構造体コピー
7. **vds_eminj_einj_dataconv()** - データ変換（標準→集団）
8. **vds_eminj_einj_dataconv_rev()** - データ逆変換（集団→標準）
9. **vds_eminj_erestahot_rap_dataget()** - 再始動時高温保護データ取得
10. **vds_eminj_erdpn_rap_dataget()** - PN抑制保護データ取得
11. **vds_eminj_dummy_emedi_dataget()** - ダミーデータ取得（標準）
12. **vds_eminj_dummy_emedi_dataget2()** - ダミーデータ取得（集団）

## 新規仕様（eminj-acw-16）での想定変更点

### 1. 新規追加が必要な関数

#### OBD関連ラッパー関数
```c
#if (JEOBDAFIMB_D == u1g_EJCC_USE) && (JEEFI == u1g_EJCC_DUAL) && (EMINJ_IMBRQ_MEDI == ON)
/*********************************************************************/
/* �֐���         |  vds_eminj_eimbrq_rap_dataget                    */
/* ���T           |  �����ݽOBD�v���ɂ�鱸è�ސ���f�[�^�擾          */
/* ���� ptt_store |  �f�[�^�i�[�̂��p�\����                          */
/* �߂�l         |  �Ȃ�                                              */
/*********************************************************************/
static void
vds_eminj_eimbrq_rap_dataget( st_EMINJ_EMINJ_DEF *ptt_store )
{
    /* �����ݽOBD�v���ɂ�鱸è�ސ���f�[�^�擾 */
    vdg_eimbrq_emedi_dataget( ptt_store );
}
#endif /* JEOBDAFIMB_D JEEFI EMINJ_IMBRQ_MEDI */

#if (JEOBDMF == u1g_EJCC_USE) && (JEEFI == u1g_EJCC_DUAL) && (EMINJ_MFINJRQ_MEDI == ON)
/*********************************************************************/
/* �֐���         |  vds_eminj_emfinjrq_rap_dataget                  */
/* ���T           |  ����OBD�v���ɂ�鱸è�ސ���f�[�^�擾            */
/* ���� ptt_store |  �f�[�^�i�[�̂��p�\����                          */
/* �߂�l         |  �Ȃ�                                              */
/*********************************************************************/
static void
vds_eminj_emfinjrq_rap_dataget( st_EMINJ_EMINJ_DEF *ptt_store )
{
    /* ����OBD�v���ɂ�鱸è�ސ���f�[�^�擾 */
    vdg_emfinjrq_emedi_dataget( ptt_store );
}
#endif /* JEOBDMF JEEFI EMINJ_MFINJRQ_MEDI */

#if (JEOBDFKG == u1g_EJCC_USE) && (JEEFI == u1g_EJCC_DUAL) && (EMINJ_FKGDRQ_MEDI == ON)
/*********************************************************************/
/* �֐���         |  vds_eminj_efkgdrq_rap_dataget                   */
/* ���T           |  �R���nOBD�v���ɂ�鱸è�ސ���f�[�^�擾           */
/* ���� ptt_store |  �f�[�^�i�[�̂��p�\����                          */
/* �߂�l         |  �Ȃ�                                              */
/*********************************************************************/
static void
vds_eminj_efkgdrq_rap_dataget( st_EMINJ_EMINJ_DEF *ptt_store )
{
    /* �R���nOBD�v���ɂ�鱸è�ސ���f�[�^�擾 */
    vdg_efkgdrq_emedi_dataget( ptt_store );
}
#endif /* JEOBDFKG JEEFI EMINJ_FKGDRQ_MEDI */
```

#### PL多段噴射制御ラッパー関数
```c
#if (JEPLMLT_E == u1g_EJCC_USE) && (EMINJ_BINJPLCTR_MEDI == ON)
/*********************************************************************/
/* �֐���         |  vds_eminj_ebinjplctr_rap_dataget                */
/* ���T           |  �߰�����ĕ��˂�p������{���ː���f�[�^�擾        */
/* ���� ptt_store |  �f�[�^�i�[�̂��p�\����                          */
/* �߂�l         |  �Ȃ�                                              */
/*********************************************************************/
static void
vds_eminj_ebinjplctr_rap_dataget( st_EMINJ_EMINJ_DEF *ptt_store )
{
    /* �߰�����ĕ��˂�p������{���ː���f�[�^�擾 */
    vdg_ebinjplctr_emedi_dataget( ptt_store );
}
#endif /* JEPLMLT_E EMINJ_BINJPLCTR_MEDI */

#if (JEALLHV_E == u1g_EJCC_ALLHV_E) && (JEPLMLT_E == u1g_EJCC_USE) && (EMINJ_BINJPLCTR_WC_MEDI == ON)
/*********************************************************************/
/* �֐���         |  vds_eminj_ebinjplctr_wc_rap_dataget             */
/* ���T           |  �߰�����ĕ��˂�p������{���ː���(�G�}�g�@��)�f�[�^�擾 */
/* ���� ptt_store |  �f�[�^�i�[�̂��p�\����                          */
/* �߂�l         |  �Ȃ�                                              */
/*********************************************************************/
static void
vds_eminj_ebinjplctr_wc_rap_dataget( st_EMINJ_EMINJ_DEF *ptt_store )
{
    /* �߰�����ĕ��˂�p������{���ː���(�G�}�g�@��)�f�[�^�擾 */
    vdg_ebinjplctr_wc_emedi_dataget( ptt_store );
}
#endif /* JEALLHV_E JEPLMLT_E EMINJ_BINJPLCTR_WC_MEDI */

#if (JEEGMG_E == u1g_EJCC_HVPLGR_E) && (JEFFV == u1g_EJCC_NOT_USE) && (JEPLMLT_E == u1g_EJCC_USE) && (EMINJ_BINJPLCTR_STAHV_MEDI == ON)
/*********************************************************************/
/* �֐���         |  vds_eminj_ebinjplctr_stahv_rap_dataget          */
/* ���T           |  �߰�����ĕ��˂�p������{���ː���(HV�n�����䎞)�f�[�^�擾 */
/* ���� ptt_store |  �f�[�^�i�[�̂��p�\����                          */
/* �߂�l         |  �Ȃ�                                              */
/*********************************************************************/
static void
vds_eminj_ebinjplctr_stahv_rap_dataget( st_EMINJ_EMINJ_DEF *ptt_store )
{
    /* �߰�����ĕ��˂�p������{���ː���(HV�n�����䎞)�f�[�^�擾 */
    vdg_ebinjplctr_stahv_emedi_dataget( ptt_store );
}
#endif /* JEEGMG_E JEFFV JEPLMLT_E EMINJ_BINJPLCTR_STAHV_MEDI */
```

#### 始動燃焼制御ラッパー関数
```c
#if ((JERMTCTR == u1g_EJCC_USE) || (JENVCTR == u1g_EJCC_USE)) && (JEMICN_E != u1g_EJCC_SUB_E) && (EMINJ_STACM_MEDI == ON)
/*********************************************************************/
/* �֐���         |  vds_eminj_estacm_rap_dataget                    */
/* ���T           |  �n���������オ�萧��f�[�^�擾                    */
/* ���� ptt_store |  �f�[�^�i�[�̂��p�\����                          */
/* �߂�l         |  �Ȃ�                                              */
/*********************************************************************/
static void
vds_eminj_estacm_rap_dataget( st_EMINJ_EMINJ_DEF *ptt_store )
{
    /* �n���������オ�萧��f�[�^�擾 */
    vdg_estacm_emedi_dataget( ptt_store );
}
#endif /* JERMTCTR JENVCTR JEMICN_E EMINJ_STACM_MEDI */
```

### 2. vdg_eminj_8msm() 関数への追加

調停処理の switch 文に以下のケースを追加：

```c
void
vdg_eminj_8msm( void )
{
    /* ... 既存のコード ... */
    
    /* 優先度に基づく調停処理 */
    switch( u1t_id )
    {
        /* ... 既存のケース ... */
        
#if (JEOBDAFIMB_D == u1g_EJCC_USE) && (JEEFI == u1g_EJCC_DUAL) && (EMINJ_IMBRQ_MEDI == ON)
        case u1g_EMINJ_IMBRQ_ID:
            vds_eminj_eimbrq_rap_dataget( &sts_data );
            break;
#endif /* JEOBDAFIMB_D JEEFI EMINJ_IMBRQ_MEDI */

#if (JEOBDMF == u1g_EJCC_USE) && (JEEFI == u1g_EJCC_DUAL) && (EMINJ_MFINJRQ_MEDI == ON)
        case u1g_EMINJ_MFINJRQ_ID:
            vds_eminj_emfinjrq_rap_dataget( &sts_data );
            break;
#endif /* JEOBDMF JEEFI EMINJ_MFINJRQ_MEDI */

#if (JEOBDFKG == u1g_EJCC_USE) && (JEEFI == u1g_EJCC_DUAL) && (EMINJ_FKGDRQ_MEDI == ON)
        case u1g_EMINJ_FKGDRQ_ID:
            vds_eminj_efkgdrq_rap_dataget( &sts_data );
            break;
#endif /* JEOBDFKG JEEFI EMINJ_FKGDRQ_MEDI */

#if (JEPLMLT_E == u1g_EJCC_USE) && (EMINJ_BINJPLCTR_MEDI == ON)
        case u1g_EMINJ_BINJPLCTR_ID:
            vds_eminj_ebinjplctr_rap_dataget( &sts_data );
            break;
#endif /* JEPLMLT_E EMINJ_BINJPLCTR_MEDI */

#if (JEALLHV_E == u1g_EJCC_ALLHV_E) && (JEPLMLT_E == u1g_EJCC_USE) && (EMINJ_BINJPLCTR_WC_MEDI == ON)
        case u1g_EMINJ_BINJPLCTR_WC_ID:
            vds_eminj_ebinjplctr_wc_rap_dataget( &sts_data );
            break;
#endif /* JEALLHV_E JEPLMLT_E EMINJ_BINJPLCTR_WC_MEDI */

#if (JEEGMG_E == u1g_EJCC_HVPLGR_E) && (JEFFV == u1g_EJCC_NOT_USE) && (JEPLMLT_E == u1g_EJCC_USE) && (EMINJ_BINJPLCTR_STAHV_MEDI == ON)
        case u1g_EMINJ_BINJPLCTR_STAHV_ID:
            vds_eminj_ebinjplctr_stahv_rap_dataget( &sts_data );
            break;
#endif /* JEEGMG_E JEFFV JEPLMLT_E EMINJ_BINJPLCTR_STAHV_MEDI */

#if ((JERMTCTR == u1g_EJCC_USE) || (JENVCTR == u1g_EJCC_USE)) && (JEMICN_E != u1g_EJCC_SUB_E) && (EMINJ_STACM_MEDI == ON)
        case u1g_EMINJ_STACM_ID:
            vds_eminj_estacm_rap_dataget( &sts_data );
            break;
#endif /* JERMTCTR JENVCTR JEMICN_E EMINJ_STACM_MEDI */

#if EMINJ_FREE0 == ON
        case u1g_EMINJ_FREE0_ID:
            vds_eminj_efree0_emedi_dataget( &sts_data );
            break;
#endif /* EMINJ_FREE0 */

        /* ... FREE1 - FREE11 も同様に追加 ... */
        
        default:
            /* ダミーデータ設定 */
            vds_eminj_dummy_emedi_dataget( &sts_data );
            break;
    }
    
    /* ... 既存のコード ... */
}
```

### 3. インクルードファイルの追加

ファイル冒頭のインクルードセクションに以下を追加：

```c
/*-------------------------------------------------------------------*/
/* �w�b�_�t�@�C���̃C���N���[�h                                      */
/*-------------------------------------------------------------------*/
/* ... 既存のインクルード ... */

#if (JEOBDAFIMB_D == u1g_EJCC_USE) && (JEEFI == u1g_EJCC_DUAL) && (EMINJ_IMBRQ_MEDI == ON)
#include <engsrc/efunc/eemi/eactive/eimbrq.h>     /* vdg_eimbrq_emedi_dataget() */
#endif /* JEOBDAFIMB_D JEEFI EMINJ_IMBRQ_MEDI */

#if (JEOBDMF == u1g_EJCC_USE) && (JEEFI == u1g_EJCC_DUAL) && (EMINJ_MFINJRQ_MEDI == ON)
#include <engsrc/efunc/eemi/eactive/emfinjrq.h>   /* vdg_emfinjrq_emedi_dataget() */
#endif /* JEOBDMF JEEFI EMINJ_MFINJRQ_MEDI */

#if (JEOBDFKG == u1g_EJCC_USE) && (JEEFI == u1g_EJCC_DUAL) && (EMINJ_FKGDRQ_MEDI == ON)
#include <engsrc/efunc/eemi/eactive/efkgdrq.h>    /* vdg_efkgdrq_emedi_dataget() */
#endif /* JEOBDFKG JEEFI EMINJ_FKGDRQ_MEDI */

#if (JEPLMLT_E == u1g_EJCC_USE) && (EMINJ_BINJPLCTR_MEDI == ON)
#include <engsrc/efunc/eemi/eactive/ebinjplctr.h> /* vdg_ebinjplctr_emedi_dataget() */
#endif /* JEPLMLT_E EMINJ_BINJPLCTR_MEDI */

#if (JEALLHV_E == u1g_EJCC_ALLHV_E) && (JEPLMLT_E == u1g_EJCC_USE) && (EMINJ_BINJPLCTR_WC_MEDI == ON)
/* ebinjplctr.h で関数定義済み */
#endif /* JEALLHV_E JEPLMLT_E EMINJ_BINJPLCTR_WC_MEDI */

#if (JEEGMG_E == u1g_EJCC_HVPLGR_E) && (JEFFV == u1g_EJCC_NOT_USE) && (JEPLMLT_E == u1g_EJCC_USE) && (EMINJ_BINJPLCTR_STAHV_MEDI == ON)
/* ebinjplctr.h で関数定義済み */
#endif /* JEEGMG_E JEFFV JEPLMLT_E EMINJ_BINJPLCTR_STAHV_MEDI */

#if ((JERMTCTR == u1g_EJCC_USE) || (JENVCTR == u1g_EJCC_USE)) && (JEMICN_E != u1g_EJCC_SUB_E) && (EMINJ_STACM_MEDI == ON)
#include <engsrc/efunc/eemi/eactive/estacm.h>     /* vdg_estacm_emedi_dataget() */
#endif /* JERMTCTR JENVCTR JEMICN_E EMINJ_STACM_MEDI */
```

## 実装チェックリスト

### Phase 1: 関数宣言の追加
- [ ] static関数のプロトタイプ宣言を追加（ファイル冒頭）
- [ ] 新規関数: `vds_eminj_eimbrq_rap_dataget()`
- [ ] 新規関数: `vds_eminj_emfinjrq_rap_dataget()`
- [ ] 新規関数: `vds_eminj_efkgdrq_rap_dataget()`
- [ ] 新規関数: `vds_eminj_ebinjplctr_rap_dataget()`
- [ ] 新規関数: `vds_eminj_ebinjplctr_wc_rap_dataget()`
- [ ] 新規関数: `vds_eminj_ebinjplctr_stahv_rap_dataget()`
- [ ] 新規関数: `vds_eminj_estacm_rap_dataget()`

### Phase 2: 関数実装の追加
- [ ] OBD関連ラッパー関数の実装
- [ ] PL多段噴射制御ラッパー関数の実装
- [ ] 始動燃焼制御ラッパー関数の実装
- [ ] 各関数のコメント追加（CP932）

### Phase 3: 調停処理への統合
- [ ] `vdg_eminj_8msm()` の switch 文に新規ケース追加
- [ ] 優先度順での呼び出し確認
- [ ] デフォルトケースの適切な処理

### Phase 4: インクルードファイルの整備
- [ ] 新規モジュールのヘッダーファイルをインクルード
- [ ] コンパイル条件の適切な設定
- [ ] 循環インクルードの回避確認

### Phase 5: 静的変数の追加（必要に応じて）
- [ ] 新規モジュールのデータ格納用static変数
- [ ] 初期化処理の追加（`vdg_eminj_pwon()`内）

## ベースファイルからの変更サマリー

### 追加項目
1. **新規関数**: 7個（OBD×3, PL多段×3, 始動燃焼×1）
2. **調停ケース**: 7個（switch文に追加）
3. **インクルード**: 5個（新規モジュールヘッダー）
4. **静的変数**: 必要に応じて（データ格納用）

### 変更なし項目
1. 既存の関数インターフェース
2. データ構造体定義
3. 優先度調停アルゴリズム
4. データ変換ロジック

## コンパイル・テスト

### コンパイル方法
```bash
# GHS R9 コンパイラを使用
ghs -c -O2 -cpu=rh850g3m -sda=all -dual_debug \
    -I../inc \
    -I../engsrc/espc \
    -I../engsrc/inc \
    -I../engsrc/eactmedi/einj \
    -I../engsrc/efunc/eemi/eactive \
    -I../engsrc/efunc/edrblty/eels \
    -I../engsrc/efunc/eeco/ehv \
    -I../engsrc/efunc/eeco/ess \
    -I../engsrc/efunc/eesta \
    -I../engsrc/efunc/edrblty/eknk \
    -I../engsrc/efunc/eprotectf/efuel \
    -I../engsrc/efunc/efunctran \
    eminj_l_mat.c \
    -o eminj_l_mat.o
```

### テスト項目
1. **コンパイルテスト**
   - [ ] 全コンパイルスイッチパターンでエラーなし
   - [ ] 警告の確認と対処
   
2. **リンクテスト**
   - [ ] 外部参照の解決確認
   - [ ] シンボルの重複なし
   
3. **機能テスト**
   - [ ] 各モジュールからのデータ取得確認
   - [ ] 優先度調停の正常動作確認
   - [ ] リミット処理の動作確認

## 注意事項

### Excel仕様書からの情報抽出が必要
以下のExcelファイルを詳細分析し、具体的な変更内容を確定する必要があります：

1. **ロジック変更シート_ver9.09_eminj.xlsx**
   - 関数ロジックの具体的な変更内容
   - パラメータ計算式の変更
   - 条件分岐の変更

2. **参照元チェックシート_ver2.11_eminj-acw-16-a-t.xlsx**
   - 新規モジュールの呼び出しIF確認
   - パラメータの型確認
   - エラーハンドリング確認

3. **参照先チェックシート_eminj-acw-16-a-t.xlsx**
   - 外部公開IFの変更確認
   - データ構造体の変更確認

### 現状の制約
**本レポートは、Excel仕様書への直接アクセスなしで作成されています。**

実際の実装には、以下が必要です：
1. Excel仕様書の詳細分析
2. 具体的なロジック変更の特定
3. 新規モジュールのIF仕様確認
4. テストケースの作成

## 次ステップ

### 即座に実施可能な作業
1. ベースファイルのバックアップ作成 ✓（完了）
2. 新規関数の skelton 追加
3. インクルードファイルの追加
4. コンパイルテスト

### Excel仕様書分析後の作業
1. ロジック変更の詳細実装
2. パラメータ計算式の更新
3. 条件分岐の修正
4. テストケースの実行

## 結論

**eminj_l_mat.c は構造的には acw-16 に対応可能**

ベースファイル（eminj-acw-15）の構造は、新規機能の追加に対応できる設計になっています。
具体的なロジック変更は、Excel仕様書の詳細分析により実装します。

---

**作成者**: Copilot Workspace  
**作成日**: 2025-11-07  
**版数**: 1.0

**重要**: このレポートは、Excel仕様書への直接アクセスなしで作成された暫定版です。
実際の実装には、仕様書の詳細分析が不可欠です。
